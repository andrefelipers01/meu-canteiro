<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Planta Baixa - Canteiro de Obras</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: #f9f9f9;
            margin: 0;
            padding: 0;
        }
        .container {
            max-width: 980px;
            margin: 30px auto;
            background: #fff;
            border-radius: 12px;
            box-shadow: 0 2px 14px rgba(0,0,0,.08);
            padding: 35px;
        }
        h1 {
            color: #2b4162;
            font-size: 2.2rem;
        }
        form {
            margin-bottom: 22px;
        }
        label {
            margin-right: 15px;
            font-size: 1.07rem;
        }
        input[type="text"], input[type="number"] {
            margin-right: 12px;
            padding: 6px 9px;
            font-size: 1.03rem;
        }
        button, .zoom-btn {
            background: #2b4162;
            color: #fff;
            border: none;
            padding: 8px 22px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 17px;
            margin-right: 0.3rem;
        }
        .zoom-btn {
            padding: 6px 17px;
            font-size: 21px;
            margin-right: 10px;
        }
        #canvas {
            margin-top: 35px;
            background: #ececec;
            border: 2px solid #2b4162;
            border-radius: 8px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        .areas-list {
            margin-top: 25px;
        }
        .areas-list li {
            color: #555;
            font-size: 1.00rem;
        }
        .controls {
            margin-top: 15px;
            margin-bottom: 5px;
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .caninteiro-form{
            margin-bottom: 18px;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            #canvas,
            #canvas * {
                visibility: visible !important;
            }
            #printArea {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .container {
                box-shadow: none;
                padding: 0;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h1>Gerador de Planta Baixa para Canteiro de Obras</h1>
    <form id="canteiroForm" class="caninteiro-form">
        <label>
            Largura do Canteiro (m): <input type="number" id="siteWidth" min="1.2" step="0.6" required placeholder="ex: 12" />
        </label>
        <label>
            Comprimento do Canteiro (m): <input type="number" id="siteLength" min="1.2" step="0.6" required placeholder="ex: 24" />
        </label>
        <button type="submit">Definir Canteiro</button>
    </form>
    <form id="areaForm" style="display:none;">
        <label>
            Nome da Área:
            <input type="text" id="areaName" required placeholder="ex: Depósito">
        </label>
        <label>
            Tamanho (m²):
            <input type="number" id="areaSize" min="0.36" max="500" step="0.01" required placeholder="ex: 20">
        </label>
        <button type="submit">Adicionar Área</button>
    </form>
    <div>
        <strong>Áreas Adicionadas:</strong>
        <ul class="areas-list" id="areasList"></ul>
    </div>
    <div class="controls" style="display:none;">
        <button class="zoom-btn" id="zoomIn">+</button>
        <button class="zoom-btn" id="zoomOut">-</button>
        <button id="printBtn">Imprimir Planta</button>
        <span style="font-size:14px;color:#888">Use os botões para aproximar/afastar (zoom) ou imprimir a planta baixa.</span>
    </div>
    <canvas id="canvas" width="800" height="400"></canvas>
    <p style="font-size:13px;color:#888">A planta é ilustrativa. Cada ambiente é ajustado a múltiplos de 0,6m.</p>
</div>
<script>
// --- LÓGICA DE CANTEIRO
const siteForm = document.getElementById('canteiroForm');
const areaForm = document.getElementById('areaForm');
const siteWidthInput = document.getElementById('siteWidth');
const siteLengthInput = document.getElementById('siteLength');
const controlsDiv = document.querySelector('.controls');
const areasList = document.getElementById('areasList');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const zoomInBtn = document.getElementById('zoomIn');
const zoomOutBtn = document.getElementById('zoomOut');
const printBtn = document.getElementById('printBtn');

let siteWidth = 0; // largura do canteiro (m)
let siteLength = 0; // comprimento do canteiro (m)
let areas = [];     // cada área: {name, size, width, length}
let zoom = 1;

// --- AJUDANTE ARREDONDAMENTO PARA MÚLTIPLOS DE 0.6m
function round06(x) {
    return Math.round(x / 0.6) * 0.6;
}

// --- LAYOUT DE AMBIENTES (colocação tipo "linha por linha", respeitando limite do canteiro)
function drawPlant() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.save();
    ctx.scale(zoom, zoom);

    // "padding" e dimensões úteis
    const padding = 28; // espaço interno para ficar bonito
    const usableWidth = (canvas.width - 2*padding) / zoom;
    const usableHeight = (canvas.height - 2*padding) / zoom;

    // proporção: metros -> pixels
    const pxPerM_W = usableWidth / siteWidth;
    const pxPerM_L = usableHeight / siteLength;

    // desenha limite do canteiro
    ctx.strokeStyle = '#2b4162';
    ctx.setLineDash([]);
    ctx.lineWidth = 4;
    ctx.strokeRect(padding, padding, pxPerM_W * siteWidth, pxPerM_L * siteLength);

    // posicionamento line by line
    let xAtual = 0, yAtual = 0, maxHdaLinha = 0;
    const spacing = 0.03; // espaço entre áreas em metros (não pixel!)
    let colorStep = 360/(areas.length+1);

    areas.forEach((area, i) => {
        let areaPxW = area.width * pxPerM_W;
        let areaPxL = area.length * pxPerM_L;
        if(xAtual + area.width + spacing > siteWidth + 0.0001) { // +epsilon
            // próxima linha
            xAtual = 0;
            yAtual += maxHdaLinha + spacing;
            maxHdaLinha = 0;
        }

        // não desenha se passar limite do canteiro
        if(yAtual + area.length > siteLength + 0.0001) return;

        // retângulo ambiente
        let drawX = padding + xAtual*pxPerM_W;
        let drawY = padding + yAtual*pxPerM_L;
        ctx.fillStyle = `hsl(${(i*colorStep+47)%360},72%,84%)`;
        ctx.strokeStyle = "#2b4162";
        ctx.lineWidth = 2;
        ctx.setLineDash([7,5]);
        ctx.beginPath();
        ctx.rect(drawX, drawY, areaPxW, areaPxL);
        ctx.fill();
        ctx.stroke();

        // legenda
        ctx.setLineDash([]);
        ctx.fillStyle = "#2b4162";
        ctx.font = 'bold 15px Arial';
        ctx.fillText(area.name, drawX+7, drawY+19);
        ctx.font = 'normal 13px Arial';
        ctx.fillText(`${area.width.toFixed(1)} x ${area.length.toFixed(1)} m`, drawX+7, drawY+36);
        ctx.fillText(`(${area.width*area.length} m²)`, drawX+7, drawY+54);

        // avançar posição
        maxHdaLinha = Math.max(maxHdaLinha, area.length);
        xAtual += area.width + spacing;
    });

    // grade de múltiplos 0,6m (opcional, visual)
    ctx.save();
    ctx.strokeStyle = "#aac";
    ctx.lineWidth = 1;
    ctx.setLineDash([2,6]);
    for(let x=0.6; x<siteWidth;x+=0.6){
        ctx.beginPath();
        ctx.moveTo(padding + x*pxPerM_W, padding);
        ctx.lineTo(padding + x*pxPerM_W, padding+pxPerM_L*siteLength);
        ctx.stroke();
    }
    for(let y=0.6; y<siteLength;y+=0.6){
        ctx.beginPath();
        ctx.moveTo(padding, padding + y*pxPerM_L);
        ctx.lineTo(padding+pxPerM_W*siteWidth, padding + y*pxPerM_L);
        ctx.stroke();
    }
    ctx.restore();

    // texto escala
    ctx.fillStyle = "#555";
    ctx.font = "12px Arial";
    ctx.fillText(siteWidth + " m", padding + pxPerM_W * siteWidth / 2 - 19, padding - 8);
    ctx.save();
    ctx.translate(padding - 15, padding + pxPerM_L*siteLength/2 + 19);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(siteLength + " m", 0,0);
    ctx.restore();

    ctx.restore();
}

// --- HANDLERS
siteForm.addEventListener('submit', function(e){
    e.preventDefault();
    let w = parseFloat(siteWidthInput.value);
    let l = parseFloat(siteLengthInput.value);
    // arredondar para múltiplos de 0.6 m
    w = round06(w);
    l = round06(l);
    if(w < 1.2 || l < 1.2) {
        alert("O mínimo para largura e comprimento é 1.2m.");
        return;
    }
    siteWidth = w;
    siteLength = l;
    siteWidthInput.value = w;
    siteLengthInput.value = l;
    // Exibir form das áreas + controles
    areaForm.style.display = "";
    controlsDiv.style.display = "";
    siteForm.style.display = "none";
    areas = [];
    areasList.innerHTML = '';
    drawPlant();
});

areaForm.addEventListener('submit', function(e){
    e.preventDefault();
    const name = document.getElementById('areaName').value.trim();
    let sz = parseFloat(document.getElementById('areaSize').value);
    if(!name || sz <= 0) return;

    // Encontra combinações (largura x comprimento) possíveis, múltiplos de 0.6, área >= sz
    // Fixa a largura (de 0.6 até siteWidth) e vê se há profundidade possível cabendo dentro do canteiro
    let found = null, minArea = null;
    for(let largura=0.6; largura<=siteWidth; largura+=0.6){
        let prof = Math.ceil(sz/largura/0.6)*0.6;
        if(prof > siteLength) continue;
        let areaReal = largura*prof;
        if(areaReal<sz) continue;
        // Só aceita se área encaixa, por linha (máximo), também não pode ficar com ambiente muito comprido (ratio extremo)
        if((minArea===null)||(areaReal < minArea)){
            found = {width: largura, length: prof};
            minArea = areaReal;
        }
    }
    if(!found){
        alert("Não é possível criar essa área nesse canteiro (considere aumentar as dimensões do canteiro, ou diminuir o tamanho do ambiente).");
        return;
    }

    // Verifica se sobra espaço livre (em linha), para encaixar mais um retângulo (controle de overflow)
    // Faz simulação "à la mosaico"
    let simAreas = areas.concat([{name, size: sz, width: found.width, length: found.length}]);
    let xAtual=0, yAtual=0, maxH = 0, cabe = true, spacing = 0.03;
    for(let i=0;i<simAreas.length;i++){
        if(xAtual + simAreas[i].width + spacing > siteWidth+0.0001){
            xAtual = 0;
            yAtual += maxH + spacing;
            maxH = 0;
        }
        if(yAtual + simAreas[i].length > siteLength+0.0001){
            cabe = false;
            break;
        }
        maxH = Math.max(maxH, simAreas[i].length);
        xAtual += simAreas[i].width + spacing;
    }
    if(!cabe){
        alert("Não há espaço disponível para essa área, considerando as demais já adicionadas.");
        return;
    }

    areas.push({
        name,
        size: sz,
        width: found.width,
        length: found.length
    });
    // Atualiza a lista de áreas
    areasList.innerHTML = '';
    areas.forEach((a, idx) => {
        areasList.innerHTML += `<li>${a.name} – ${a.width.toFixed(1)} x ${a.length.toFixed(1)} m <span style="color:#888;">(${(a.width*a.length).toFixed(2)} m²)</span> <button onclick="removeArea(${idx})" style="color:#c00;background:none;border:none;cursor:pointer;" title="Remover área">&times;</button></li>`;
    });
    drawPlant();
    areaForm.reset();
});

// Remover área
window.removeArea = function(idx){
    areas.splice(idx, 1);
    areasList.innerHTML = '';
    areas.forEach((a, i) => {
        areasList.innerHTML += `<li>${a.name} – ${a.width.toFixed(1)} x ${a.length.toFixed(1)} m <span style="color:#888;">(${(a.width*a.length).toFixed(2)} m²)</span> <button onclick="removeArea(${i})" style="color:#c00;background:none;border:none;cursor:pointer;" title="Remover área">&times;</button></li>`;
    });
    drawPlant();
};
// --- ZOOM
zoomInBtn.addEventListener('click', function(e) {
    e.preventDefault();
    if (zoom < 2.5) {
        zoom += 0.15;
        drawPlant();
    }
});
zoomOutBtn.addEventListener('click', function(e) {
    e.preventDefault();
    if (zoom > 0.4) {
        zoom -= 0.15;
        drawPlant();
    }
});
// --- PRINT
printBtn.addEventListener('click', function(e) {
    e.preventDefault();
    let dataUrl = canvas.toDataURL("image/png");
    let win = window.open('', '_blank');
    win.document.write(`
        <html>
          <head>
            <title>Imprimir Planta do Canteiro</title>
            <style>
            body { margin: 0; text-align: center; }
            img { max-width: 100vw; max-height: 95vh; margin: 0 auto; }
            </style>
          </head>
          <body>
            <img src="${dataUrl}" />
            <script>
              window.onload = function() {
                setTimeout(function() {
                  window.print();
                }, 350);
              }
            <\/script>
          </body>
        </html>
    `);
    win.document.close();
});

// Redesenhar ao carregar página
window.addEventListener('DOMContentLoaded', drawPlant);
</script>
</body>
</html>
